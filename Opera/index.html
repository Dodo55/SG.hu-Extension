<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<script>


		
			window.addEventListener("load", setupConnection, false);
			
			function setupConnection() {
				
				opera.extension.onmessage = function(event) {
				
					msg = event.data;
					
					if (msg.topic == 'LoadInjectedCSS') {
						loadInjectedCSS(event, msg.data);
					
					} else if(msg.type == "setBlockedUser") {
						addToBlockList(msg.data);
	
					} else if(msg.type == "setBlocksConfig") {
						setBlockConfig(msg.data);
					}
				}
			}

			function loadInjectedCSS(event, path) {
				// Try to get the contents of the stylesheet.
				var req = new XMLHttpRequest();
				req.open('GET', path, false);
				req.send();
    
				// Error check for reading the stylesheet.
				if (!req.responseText) {
					opera.postError('EXTENSION ERROR: Can\'t read ' + path);
					return;
				}
    
				// Send the contents of the stylesheet to the injected script.
				event.source.postMessage({
					topic: 'LoadedInjectedCSS',
					data: {
						css: req.responseText,
						path: path
					}
				});
			}	


			function addToBlockList(name){
		
				// If theres in no entry in localStorage
				if(typeof localStorage['block_list'] == "undefined") {
					widget.preferences['block_list'] = '';
				}
		
				// If the blocklist is empty
				if(localStorage['block_list'] == '') { 
					widget.preferences['block_list'] = name;
		
				// If the blocklist is not empty
				} else {
					var blocklist = new Array();
						blockList = widget.preferences['block_list'].split(',');
						if(blockList.indexOf(name) == -1) { blockList.push(name);  widget.preferences['block_list'] = blockList; }
				}
			}
		
			function setBlockConfig(data) {
				widget.preferences['blocks_config'] = data;
			}
		
		</script>
	</head>
</html>
